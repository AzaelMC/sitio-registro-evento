<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Evento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 90%;
        }
        @media (min-width: 768px) {
            .container {
                max-width: 500px;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 md:p-8 bg-gray-100">

    <div class="container bg-white p-8 rounded-2xl shadow-xl space-y-6">
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">Registro de Evento</h1>
            <p class="text-gray-600">Completa el formulario para asegurar tu lugar.</p>
        </div>

        <form id="registration-form" class="space-y-4">
            <div>
                <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
                <input type="text" id="nombre" name="nombre" placeholder="Ingresa tu nombre" required
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
            </div>
            <div>
                <label for="apellido" class="block text-sm font-medium text-gray-700">Apellido</label>
                <input type="text" id="apellido" name="apellido" placeholder="Ingresa tu apellido" required
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
            </div>
            <div>
                <label for="correo" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                <input type="email" id="correo" name="correo" placeholder="ejemplo@correo.com" required
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
            </div>
            <div>
                <label for="telefono" class="block text-sm font-medium text-gray-700">Teléfono (Opcional)</label>
                <input type="tel" id="telefono" name="telefono" placeholder="Ej. +52 55 1234 5678"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
            </div>
            <button type="submit" id="submit-button"
                    class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200">
                Registrarse
            </button>
        </form>

        <!-- Mensaje de estado -->
        <div id="status-message" class="text-center mt-4 text-sm font-medium" style="display: none;"></div>
    </div>

    <!-- Cargar Supabase desde CDN alternativa -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // --- Configuración de Supabase ---
        // Tus credenciales de Supabase
        const SUPABASE_URL = 'https://pisopxwisjdgglhyjfie.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpc29weHdpc2pkZ2dsaHlqZmllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMTY2NjAsImV4cCI6MjA3MjU5MjY2MH0.6BstpQGBaiFTP2MNEC0MG4TxGRie3V2zJJ2bD705gFE';

        // Inicializa el cliente de Supabase usando la variable global
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Lógica del formulario ---
        const form = document.getElementById('registration-form');
        const statusMessage = document.getElementById('status-message');
        const submitButton = document.getElementById('submit-button');

        // Función para mostrar mensajes
        function showMessage(message, isError = false) {
            statusMessage.style.display = 'block';
            statusMessage.className = `text-center mt-4 text-sm font-medium ${isError ? 'text-red-500' : 'text-green-600'}`;
            statusMessage.textContent = message;
        }

        // Función para validar email
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Deshabilitar botón y mostrar estado de carga
            submitButton.disabled = true;
            submitButton.textContent = 'Registrando...';
            statusMessage.style.display = 'block';
            statusMessage.className = 'text-center mt-4 text-sm font-medium text-gray-600';
            statusMessage.textContent = 'Procesando tu registro, por favor espera...';

            const formData = new FormData(form);
            const data = {
                nombre: formData.get('nombre').trim(),
                apellido: formData.get('apellido').trim(),
                correo: formData.get('correo').trim().toLowerCase(),
                telefono: formData.get('telefono') ? formData.get('telefono').trim() : null,
                fecha_registro: new Date().toISOString()
            };

            // Validación básica
            if (!data.nombre || !data.apellido || !data.correo) {
                submitButton.disabled = false;
                submitButton.textContent = 'Registrarse';
                showMessage('Por favor completa todos los campos obligatorios.', true);
                return;
            }

            if (!validateEmail(data.correo)) {
                submitButton.disabled = false;
                submitButton.textContent = 'Registrarse';
                showMessage('Por favor ingresa un correo electrónico válido.', true);
                return;
            }

            try {
                // Intentar insertar los datos en la tabla 'registros' de Supabase
                const { error } = await supabase
                    .from('registros')
                    .insert([data]);

                if (error) {
                    console.error('Error al registrar:', error);
                    let errorMessage = 'Hubo un error en el registro. Por favor, intenta de nuevo más tarde.';
                    
                    // Manejar diferentes tipos de error
                    if (error.code === '23505') {
                        errorMessage = 'Este correo electrónico ya está registrado.';
                    } else if (error.code === '42P01') {
                        errorMessage = 'Error de configuración de la base de datos. Contacta al administrador.';
                    } else if (error.message.includes('duplicate key')) {
                        errorMessage = 'Este correo electrónico ya está registrado.';
                    }
                    
                    showMessage(errorMessage, 'error');
                } else {
                    showMessage('¡Registro exitoso! Gracias por registrarte.', 'success');
                    form.reset();
                    
                    // Ocultar mensaje después de 5 segundos
                    setTimeout(() => {
                        document.getElementById('status-message').style.display = 'none';
                    }, 5000);
                }
            } catch (err) {
                console.error('Error de conexión:', err);
                showMessage('Error de conexión. Verifica tu internet e intenta nuevamente.', 'error');
            } finally {
                // Rehabilitar botón
                submitButton.disabled = false;
                submitButton.textContent = 'Registrarse';
            }
        });

        // Verificar conexión con Supabase al cargar la página
        window.addEventListener('load', async () => {
            try {
                const { data, error } = await supabase
                    .from('registros')
                    .select('count', { count: 'exact', head: true });
                
                if (error && error.code === '42P01') {
                    console.warn('La tabla "registros" no existe. Asegúrate de crearla en Supabase.');
                }
            } catch (err) {
                console.warn('No se pudo verificar la conexión con Supabase:', err);
            }
        });
    </script>
</body>
</html>





