<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Evento</title>
    <!-- Tailwind CSS para un diseño moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilo base para aplicar la fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
            /* Se establece la imagen de fondo directamente */
            background-image: url('https://raw.githubusercontent.com/AzaelMC/sitio-registro-evento/ea1cf087eb310562f93558e7f231a0455f288344/Mesa%20de%20trabajo%203.jpg');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: cover;
        }
        /* Estilo para el spinner de carga */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #764BA2;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6 sm:p-8 transition-transform transform-gpu hover:scale-[1.01] duration-300">
        <!-- Contenedor del Logo y Título -->
        <div class="text-center mb-6">
            <div class="flex justify-center items-center space-x-6 mb-4">
                <img src="https://raw.githubusercontent.com/AzaelMC/sitio-registro-evento/06fbeb23fe975b25bb8bda8b84217cf0fa6b1e73/logo_.png" alt="Logo del Evento" class="h-14 w-auto">
                <img src="https://raw.githubusercontent.com/AzaelMC/sitio-registro-evento/35d7c4305257bca1d37d85318cd0a037490ca559/DPP2025-LOGO-NEGRO-PNG.png" alt="Logo DPP 2025" class="h-14 w-auto">
            </div>
            <p class="text-gray-500 mt-1">Completa el formulario para asegurar tu lugar.</p>
        </div>

        <!-- Formulario de Registro -->
        <form id="registration-form" class="space-y-5">
            <!-- Campo Nombre -->
            <div>
                <label for="nombre" class="text-sm font-medium text-gray-700 block mb-1.5">Nombre *</label>
                <input type="text" id="nombre" name="nombre" placeholder="Ingresa tu nombre" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
            </div>

            <!-- Campo Apellido -->
            <div>
                <label for="apellido" class="text-sm font-medium text-gray-700 block mb-1.5">Apellido *</label>
                <input type="text" id="apellido" name="apellido" placeholder="Ingresa tu apellido" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
            </div>

            <!-- Campo Correo Institucional -->
            <div>
                <label for="correo_institucional" class="text-sm font-medium text-gray-700 block mb-1.5">Correo Institucional *</label>
                <input type="email" id="correo_institucional" name="correo_institucional" placeholder="nombre@institucion.edu" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
            </div>

            <!-- Campo Usuario de Instagram -->
            <div>
                <label for="instagram" class="text-sm font-medium text-gray-700 block mb-1.5">Usuario de Instagram *</label>
                <input type="text" id="instagram" name="instagram" placeholder="Ej. @tu_usuario" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
            </div>

            <!-- Leyenda Promocional -->
            <p class="text-center text-sm text-gray-600 font-medium pt-2">Regístrate y obtén un acceso a la Digital Pinshi Pary</p>

            <!-- Botón de Envío -->
            <button type="submit" id="submit-button" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-300 shadow-lg hover:shadow-xl flex items-center justify-center disabled:opacity-60 disabled:cursor-not-allowed">
                Registrarse
            </button>
        </form>

        <!-- Mensaje de Estado (Éxito, Error, Carga) -->
        <div id="status-message" class="mt-5 text-center text-sm font-medium p-3 rounded-lg hidden"></div>
    </div>

    <!-- Ventana Emergente de Aviso de Privacidad -->
    <div id="privacy-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-md flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 max-w-md w-full transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
            <h2 class="text-xl font-bold text-gray-800 mb-3">Aviso de Privacidad</h2>
            <p class="text-gray-600 mb-5 text-sm">
                En NTP Media valoramos y respetamos tu privacidad. La información de contacto que nos proporciones será utilizada exclusivamente para comunicarnos contigo en relación con nuestros productos, servicios y soluciones. Podrás darte de baja de nuestras comunicaciones en cualquier momento siguiendo las instrucciones incluidas en cada mensaje o solicitándolo directamente a través de nuestros canales de contacto.
            </p>
            <p class="text-gray-600 mb-6 text-sm">
                Para conocer más sobre nuestras prácticas de privacidad, el uso que damos a tus datos y nuestro compromiso con la protección de tu información personal, te invitamos a consultar nuestra Política de Privacidad completa.
            </p>
            <button id="close-modal-button" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-2.5 px-4 rounded-lg hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-300">
                He leído y acepto el aviso
            </button>
        </div>
    </div>

    <!-- Cargar cliente de Supabase desde CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // --- Configuración de Supabase ---
        const SUPABASE_URL = 'https://pisopxwisjdgglhyjfie.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpc29weHdpc2pkZ2dsaHlqZmllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMTY2NjAsImV4cCI6MjA3MjU5MjY2MH0.6BstpQGBaiFTP2MNEC0MG4TxGRie3V2zJJ2bD705gFE';

        // Inicializar el cliente de Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Lógica del Formulario ---
        const form = document.getElementById('registration-form');
        const statusMessage = document.getElementById('status-message');
        const submitButton = document.getElementById('submit-button');
        const privacyModal = document.getElementById('privacy-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const modalContent = document.getElementById('modal-content');

        /**
         * Muestra un mensaje de estado en la UI.
         * @param {string} message - El mensaje a mostrar.
         * @param {'success'|'error'|'loading'} type - El tipo de mensaje.
         */
        function showMessage(message, type) {
            statusMessage.textContent = '';
            statusMessage.innerHTML = '';
            statusMessage.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');
            
            statusMessage.classList.add('block');

            if (type === 'success') {
                statusMessage.classList.add('bg-green-100', 'text-green-800');
                statusMessage.textContent = message;
            } else if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-800');
                statusMessage.textContent = message;
            } else if (type === 'loading') {
                statusMessage.classList.add('bg-blue-100', 'text-blue-800');
                const spinner = document.createElement('div');
                spinner.className = 'loader inline-block mr-2';
                const text = document.createTextNode(message);
                statusMessage.appendChild(spinner);
                statusMessage.appendChild(text);
            }
        }

        /**
         * Valida si una cadena de texto es un correo electrónico válido.
         * @param {string} email - El correo electrónico a validar.
         * @returns {boolean} - True si es válido, false en caso contrario.
         */
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(String(email).toLowerCase());
        }
        
        // --- Manejador del evento de envío del formulario ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault(); // Evita el envío tradicional del formulario

            // Deshabilitar botón y mostrar estado de carga
            submitButton.disabled = true;
            const originalButtonText = submitButton.textContent;
            submitButton.innerHTML = `<div class="loader"></div><span class="ml-2">Registrando...</span>`;
            showMessage('Procesando tu registro, por favor espera...', 'loading');

            const formData = new FormData(form);
            const data = {
                nombre: formData.get('nombre').trim(),
                apellido: formData.get('apellido').trim(),
                correo_institucional: formData.get('correo_institucional').trim().toLowerCase(),
                instagram: formData.get('instagram').trim(), 
                fecha_registro: new Date().toISOString()
            };

            // Validación de campos
            if (!data.nombre || !data.apellido || !data.correo_institucional || !data.instagram) {
                showMessage('Por favor completa todos los campos obligatorios.', 'error');
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
                return;
            }

            if (!validateEmail(data.correo_institucional)) {
                showMessage('Por favor ingresa un correo electrónico válido.', 'error');
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
                return;
            }

            // Intento de inserción en Supabase
            try {
                const { error } = await supabase
                    .from('registros') // Nombre de tu tabla en Supabase
                    .insert([data]);

                if (error) {
                    console.error('Error al registrar:', error);
                    let errorMessage = 'Hubo un error en el registro. Intenta de nuevo más tarde.';
                    
                    // Manejo de error específico para correo duplicado
                    if (error.code === '23505' || error.message.includes('duplicate key')) {
                        errorMessage = 'Este correo electrónico ya ha sido registrado.';
                    }
                    
                    showMessage(errorMessage, 'error');
                } else {
                    showMessage('¡Registro exitoso! Gracias por registrarte.', 'success');
                    form.reset(); // Limpia el formulario
                    
                    // Ocultar mensaje de éxito después de 5 segundos
                    setTimeout(() => {
                        statusMessage.classList.add('hidden');
                    }, 5000);
                }
            } catch (err) {
                console.error('Error de conexión:', err);
                showMessage('Error de conexión. Verifica tu internet e intenta nuevamente.', 'error');
            } finally {
                // Rehabilitar el botón al finalizar
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }
        });

        // --- Lógica de la Ventana Emergente y Carga de Página ---
        window.addEventListener('load', () => {
            // Lógica de la ventana emergente
            if (!localStorage.getItem('privacyNoticeAccepted')) {
                privacyModal.classList.remove('hidden');
                // Pequeño retraso para la animación de entrada
                setTimeout(() => {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }, 50);
            }

            // Lógica de Supabase
            (async () => {
                try {
                    const { error } = await supabase
                        .from('registros')
                        .select('count', { count: 'exact', head: true });
                    
                    if (error && error.code === '42P01') {
                        console.warn('Advertencia: La tabla "registros" no parece existir. Asegúrate de haberla creado en tu proyecto de Supabase.');
                    }
                } catch (err) {
                    console.warn('No se pudo verificar la conexión con Supabase al cargar la página.', err);
                }
            })();
        });

        closeModalButton.addEventListener('click', () => {
            localStorage.setItem('privacyNoticeAccepted', 'true');
            modalContent.classList.add('scale-95', 'opacity-0');
            // Esperar a que la animación termine antes de ocultar el contenedor
            setTimeout(() => {
                privacyModal.classList.add('hidden');
            }, 300);
        });
    </script>
</body>
</html>





